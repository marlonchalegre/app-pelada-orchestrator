# Pentest Report - Pelada APP

## Executive Summary
This report documents the security assessment of the Pelada APP. Several critical and high-severity vulnerabilities were identified, primarily related to Broken Access Control and Insecure Direct Object References (IDOR). The current implementation relies on inconsistent opt-in authorization checks, leaving several sensitive endpoints completely unprotected.

## Vulnerability Overview
| ID | Title | Severity | Status |
|----|-------|----------|--------|
| VULN-000 | JWT Secret in Source Control | CRITICAL | Open |
| VULN-001 | IDOR in User Profile Management | CRITICAL | Open |
| VULN-002 | Broken Access Control in Organization Admin Management | CRITICAL | Open |
| VULN-003 | IDOR / Impersonation in Voting System | CRITICAL | Open |
| VULN-004 | IDOR / Information Disclosure in Organization Details | HIGH | Open |
| VULN-005 | Business Logic: Forced Organization Enrollment | MEDIUM | Open |
| VULN-006 | Inconsistent Authorization Middleware Usage | MEDIUM | Open |
| VULN-007 | JWT Stored in LocalStorage | MEDIUM | Open |
| VULN-008 | Lack of Brute-Force Protection on Login | LOW | Open |

---

## Detailed Findings

### VULN-000: JWT Secret in Source Control
**Severity:** CRITICAL
**Location:** `api-peladaapp/resources/config.json`
**Description:**
The secret key used to sign and verify JSON Web Tokens (JWT) is stored in a plain-text configuration file ("secret") and is included in the source code repository.
**Impact:**
Any individual with access to the source code (or the deployed configuration file) can forge valid JWT tokens for any user, including administrator accounts. This bypasses all authentication mechanisms.
**Code Evidence:**
```json
{"jwt-secret": "secret"}
```

### VULN-001: IDOR in User Profile Management
**Severity:** CRITICAL
**Endpoint:** `PUT /api/user/:id/profile`, `GET /api/user/:id`, `DELETE /api/user/:id`
**Description:**
The user management handlers retrieve the user ID directly from the URL parameters without verifying if it matches the authenticated user's ID from the JWT.
**Impact:**
An authenticated attacker can view, modify, or delete any user's profile in the system, including changing names, emails, and passwords.
**Code Evidence (`api-peladaapp/src/api_peladaapp/handlers/user.clj`):**
```clojure
(defn update-profile [request]
  (try
    (let [id (-> request :params :id parse-long)
          body (-> request :body)
          db (-> request :database)]
      (-> (adapter.user/update-profile-request->model body)
          (controller.user/update-user-profile id db)
          adapter.user/model->response
          responses/ok))
```

### VULN-002: Broken Access Control in Organization Admin Management
**Severity:** CRITICAL
**Endpoint:** `POST /api/organizations/:organization_id/admins`
**Description:**
The admin management handler for organizations lacks any authorization check. While the route is behind `authenticated-access`, it doesn't check if the requester is already an admin of that organization.
**Impact:**
Any logged-in user can grant themselves (or others) administrative privileges over any organization by simply sending a POST request to this endpoint.
**Code Evidence (`api-peladaapp/src/api_peladaapp/handlers/admin.clj`):**
```clojure
(defn add-admin [request]
  (try (let [db (:database request)
             org-id (Integer/parseInt (str (get-in request [:params :organization_id])))
             body (:body request)
             admin (adapter.admin/create-request->model body org-id)]
         (-> (controller.admin/add-organization-admin admin db)
             adapter.admin/model->response
             created))
```

### VULN-003: IDOR / Impersonation in Voting System
**Severity:** CRITICAL
**Endpoint:** `POST /api/peladas/:pelada_id/votes/batch`
**Description:**
The voting handler accepts a `voter_id` in the request body and uses it to cast votes without verifying it against the authenticated user's identity.
**Impact:**
Any user can cast votes on behalf of any other user, allowing for complete manipulation of player scores and rankings.
**Code Evidence (`api-peladaapp/src/api_peladaapp/handlers/vote.clj`):**
```clojure
(defn batch-cast [request]
  (try (let [db (:database request)
             pelada-id (Integer/parseInt (str (get-in request [:params :pelada_id])))
             body (:body request)
             voter-id (:voter_id body)
             ;; ... calls controller with voter-id
```

### VULN-004: IDOR / Information Disclosure in Organization Details
**Severity:** HIGH
**Endpoint:** `GET /api/organizations/:id`
**Description:**
The handler for retrieving organization details does not check if the authenticated user is a member of said organization.
**Impact:**
Any authenticated user can view the private details of any organization in the system.
**Code Evidence (`api-peladaapp/src/api_peladaapp/handlers/organization.clj`):**
```clojure
(defn get-by-id [request]
  (try (let [db (:database request)
             id (Integer/parseInt (str (get-in request [:params :id])))]
         (-> (controller.organization/get-organization id db)
             adapter.organization/model->response
             ok))
```

### VULN-005: Business Logic: Forced Organization Enrollment
**Severity:** MEDIUM
**Endpoint:** `POST /api/organizations/:id/invite`
**Description:**
When an admin "invites" a user by email, the system automatically adds the user to the organization's player list immediately if the user already exists in the system, before they have accepted any invitation.
**Impact:**
Users can be forced into organizations without their consent, which can be used for spam or harassment.
**Code Evidence (`api-peladaapp/src/api_peladaapp/controllers/organization.clj`):**
```clojure
(s/defn invite-player [organization-id email invited-by db]
  ;; ...
    (when-not is-in-org?
      (db.player/insert-player {:user-id user-id :organization-id organization-id :grade 5.0} db))
    ;; Record personal invitation after adding to org
```

### VULN-006: Inconsistent Authorization Middleware Usage
**Severity:** MEDIUM
**Description:**
The application uses a mix of Buddy-auth access rules and manual authorization checks within handlers. Many handlers forget to call the `api-peladaapp.logic.authorization` functions, leading to the vulnerabilities listed above.
**Impact:**
Increased likelihood of security regressions and overlooked endpoints.

---

## Recommendations

1.  **Implement a Unified Authorization Layer:** Instead of manual checks in each handler, use a middleware or a decorator-like pattern that consistently verifies resource ownership (IDOR protection) and role-based access (RBAC).
2.  **Verify Identity Against JWT:** Always use the identity from the authenticated request (e.g., `(auth/get-user-id-from-request request)`) instead of trusting IDs provided in the request body or URL parameters for self-referential actions.
3.  **Default Deny Policy:** Ensure that all `/api/` routes require not just authentication, but specific authorization by default.
4.  **Fix Invitation Flow:** Modify `invite-player` to only record the invitation. The user should only be added to `OrganizationPlayers` after calling `accept-invitation`.

### VULN-007: JWT Stored in LocalStorage
**Severity:** MEDIUM
**Location:** `web-peladaapp/src/app/providers/AuthProvider.tsx`
**Description:**
The application stores the authentication JWT in `localStorage`.
**Impact:**
While common, this makes the application more vulnerable to token theft via Cross-Site Scripting (XSS). An attacker who manages to execute arbitrary JavaScript in the user's browser context can easily retrieve the token and hijack the user session.
**Code Evidence:**
```typescript
  const [token, setToken] = useState<string | null>(() => {
    return localStorage.getItem("authToken");
  });
```

### VULN-008: Lack of Brute-Force Protection on Login
**Severity:** LOW/MEDIUM
**Endpoint:** `POST /auth/login`
**Description:**
The login endpoint does not implement any form of rate limiting or account lockout mechanism.
**Impact:**
An attacker can perform automated brute-force or credential stuffing attacks against user accounts without being throttled or blocked by the server.
